import React from 'react';
import HTML5Backend from 'react-dnd-html5-backend';
import SVGO from 'worker-loader!../web-workers/svgo.js';
import { DragDropContext, DropTarget } from 'react-dnd';
import { NativeTypes } from 'react-dnd-html5-backend';
import mapboxgl from 'mapbox-gl';
import MapboxDraw from '@mapbox/mapbox-gl-draw/dist/mapbox-gl-draw';
import { pathologize } from '../pathologize';
import { pathToCoords } from '../path-to-coordinates';
import { saveAs } from 'filesaver.js';

const turf = require('@turf/turf');

let testHI = {"geometry": {"type": "MultiPolygon", "coordinates": [[[[-171.73761, 25.792097], [-171.722366, 25.789583], [-171.71846, 25.77659], [-171.720078, 25.762859], [-171.730728, 25.75107], [-171.74614, 25.750568], [-171.751465, 25.760164], [-171.751389, 25.781382], [-171.73761, 25.792097]]], [[[-167.998505, 24.997116], [-167.99939, 24.999472], [-167.999969, 25.001759], [-168.001266, 25.005043], [-167.997711, 25.004431], [-167.99556, 25.001871], [-167.995834, 24.998215], [-167.998505, 24.997116]]], [[[-166.253326, 23.872839], [-166.2453, 23.871731], [-166.247986, 23.867916], [-166.252747, 23.869291], [-166.253326, 23.872839]]], [[[-166.297455, 23.869505], [-166.283691, 23.872631], [-166.278641, 23.870165], [-166.280426, 23.866076], [-166.292633, 23.864462], [-166.297989, 23.86611], [-166.297455, 23.869505]]], [[[-166.225662, 23.865953], [-166.218231, 23.861296], [-166.216766, 23.854198], [-166.220642, 23.853935], [-166.223907, 23.858036], [-166.226562, 23.862135], [-166.225662, 23.865953]]], [[[-166.214935, 23.786917], [-166.212082, 23.787283], [-166.208633, 23.783916], [-166.209152, 23.781681], [-166.211899, 23.781967], [-166.213821, 23.78393], [-166.214935, 23.786917]]], [[[-166.174179, 23.736132], [-166.170227, 23.731037], [-166.169724, 23.726048], [-166.172852, 23.728069], [-166.173676, 23.731142], [-166.174179, 23.736132]]], [[[-164.711365, 23.583843], [-164.700821, 23.576902], [-164.689255, 23.574688], [-164.693848, 23.569117], [-164.706085, 23.569265], [-164.712448, 23.575563], [-164.711365, 23.583843]]], [[[-161.938049, 23.071775], [-161.910767, 23.065514], [-161.910156, 23.055073], [-161.922623, 23.050011], [-161.935745, 23.053579], [-161.938049, 23.071775]]], [[[-159.431707, 22.220015], [-159.40732, 22.230555], [-159.388119, 22.223252], [-159.385977, 22.220009], [-159.367563, 22.214906], [-159.359842, 22.214831], [-159.357227, 22.217744], [-159.353795, 22.217669], [-159.339964, 22.208519], [-159.315613, 22.186817], [-159.308855, 22.155555], [-159.297808, 22.149748], [-159.295875, 22.144547], [-159.295271, 22.13039], [-159.297143, 22.113815], [-159.317451, 22.080944], [-159.321667, 22.063411], [-159.324775, 22.05867], [-159.333267, 22.054639], [-159.337996, 22.046575], [-159.341401, 22.028978], [-159.333224, 21.973005], [-159.333109, 21.964176], [-159.334714, 21.961099], [-159.350828, 21.950817], [-159.356613, 21.939546], [-159.382349, 21.924479], [-159.408284, 21.897781], [-159.425862, 21.884527], [-159.446599, 21.871647], [-159.471962, 21.88292], [-159.490914, 21.888898], [-159.517973, 21.890996], [-159.555415, 21.891355], [-159.574991, 21.896585], [-159.577784, 21.900486], [-159.584272, 21.899038], [-159.610241, 21.898356], [-159.637849, 21.917166], [-159.648132, 21.93297], [-159.671872, 21.957038], [-159.681493, 21.960054], [-159.705255, 21.963427], [-159.72014, 21.970789], [-159.758218, 21.980694], [-159.765735, 21.986593], [-159.788139, 22.018411], [-159.790932, 22.031177], [-159.786543, 22.06369], [-159.780096, 22.072567], [-159.748159, 22.100388], [-159.741223, 22.115666], [-159.733457, 22.142756], [-159.726043, 22.152171], [-159.699978, 22.165252], [-159.66984, 22.170782], [-159.608794, 22.207878], [-159.591596, 22.219456], [-159.583965, 22.22668], [-159.559643, 22.229185], [-159.554166, 22.228212], [-159.548594, 22.226263], [-159.54115, 22.216764], [-159.534594, 22.219403], [-159.523769, 22.217602], [-159.51941, 22.215646], [-159.518348, 22.211182], [-159.515574, 22.208008], [-159.507811, 22.205987], [-159.501055, 22.211064], [-159.500821, 22.225538], [-159.488558, 22.23317], [-159.480158, 22.232715], [-159.467007, 22.226529], [-159.45619, 22.228811], [-159.441809, 22.226321], [-159.431707, 22.220015]]], [[[-160.125, 21.95909], [-160.122262, 21.962881], [-160.112746, 21.995245], [-160.09645, 22.001489], [-160.072123, 22.003334], [-160.058543, 21.99638], [-160.051992, 21.983681], [-160.052729, 21.980321], [-160.056336, 21.977939], [-160.060549, 21.976729], [-160.063349, 21.978354], [-160.065811, 21.976562], [-160.078393, 21.955153], [-160.085787, 21.927295], [-160.080012, 21.910808], [-160.079065, 21.89608], [-160.098897, 21.884711], [-160.124283, 21.876789], [-160.147609, 21.872814], [-160.16162, 21.864746], [-160.174796, 21.846923], [-160.189782, 21.82245], [-160.205211, 21.789053], [-160.200427, 21.786479], [-160.205851, 21.779518], [-160.218044, 21.783755], [-160.23478, 21.795418], [-160.24961, 21.815145], [-160.244943, 21.848943], [-160.231028, 21.886263], [-160.228965, 21.889117], [-160.21383, 21.899193], [-160.205528, 21.907507], [-160.202716, 21.912422], [-160.190158, 21.923592], [-160.167471, 21.932863], [-160.13705, 21.948632], [-160.127302, 21.955508], [-160.125, 21.95909]]], [[[-160.555771, 21.668287], [-160.551041, 21.670101], [-160.54332, 21.667128], [-160.542404, 21.648081], [-160.549316, 21.645353], [-160.554123, 21.649546], [-160.555771, 21.668287]]], [[[-157.789581, 21.438396], [-157.789734, 21.437679], [-157.789276, 21.435833], [-157.790543, 21.434313], [-157.791718, 21.434881], [-157.793045, 21.43391], [-157.793167, 21.43574], [-157.791565, 21.43651], [-157.791779, 21.437752], [-157.793289, 21.437658], [-157.791779, 21.438435], [-157.791092, 21.438442], [-157.790741, 21.43874], [-157.789581, 21.438396]]], [[[-158.0668, 21.6437], [-158.066711, 21.65234], [-158.0639, 21.6584], [-158.0372, 21.6843], [-158.018127, 21.699955], [-157.9923, 21.708], [-157.98703, 21.712494], [-157.968628, 21.712704], [-157.947174, 21.689568], [-157.939, 21.669], [-157.9301, 21.6552], [-157.924591, 21.651183], [-157.9228, 21.6361], [-157.9238, 21.6293], [-157.910797, 21.611183], [-157.900574, 21.605885], [-157.87735, 21.575277], [-157.878601, 21.560181], [-157.872528, 21.557568], [-157.8669, 21.5637], [-157.85614, 21.560661], [-157.85257, 21.557514], [-157.836945, 21.529945], [-157.837372, 21.512085], [-157.849579, 21.509598], [-157.852625, 21.499971], [-157.84549, 21.466747], [-157.84099, 21.459483], [-157.82489, 21.455379], [-157.8163, 21.4502], [-157.8139, 21.4403], [-157.8059, 21.4301], [-157.786513, 21.415633], [-157.779846, 21.417309], [-157.774455, 21.421352], [-157.772209, 21.431236], [-157.774905, 21.453698], [-157.772209, 21.457741], [-157.764572, 21.461335], [-157.754239, 21.461335], [-157.737617, 21.459089], [-157.731777, 21.455944], [-157.731328, 21.444713], [-157.73582, 21.438424], [-157.740762, 21.424048], [-157.741211, 21.414614], [-157.7386, 21.4043], [-157.730191, 21.401871], [-157.728221, 21.402104], [-157.726421, 21.402845], [-157.724324, 21.403311], [-157.723794, 21.40329], [-157.723286, 21.403227], [-157.722735, 21.403121], [-157.722544, 21.403036], [-157.721845, 21.401596], [-157.721083, 21.399541], [-157.7189, 21.3961], [-157.7089, 21.3833], [-157.7087, 21.3793], [-157.7126, 21.3689], [-157.7106, 21.3585], [-157.7088, 21.3534], [-157.6971, 21.3364], [-157.6938, 21.3329], [-157.6619, 21.3131], [-157.6518, 21.3139], [-157.6537, 21.302], [-157.6946, 21.2739], [-157.6944, 21.2665], [-157.7001, 21.264], [-157.7097, 21.2621], [-157.7139, 21.2638], [-157.7142, 21.2665], [-157.7114, 21.272], [-157.7122, 21.2814], [-157.7143, 21.2845], [-157.7213, 21.2869], [-157.7572, 21.278], [-157.765, 21.2789], [-157.7782, 21.2735], [-157.7931, 21.2604], [-157.8096, 21.2577], [-157.8211, 21.2606], [-157.8241, 21.2646], [-157.8253, 21.2714], [-157.8319, 21.2795], [-157.8457, 21.29], [-157.89, 21.3065], [-157.894518, 21.319632], [-157.898969, 21.327391], [-157.90482, 21.329172], [-157.918939, 21.318615], [-157.917921, 21.313781], [-157.913469, 21.310983], [-157.910925, 21.305768], [-157.952263, 21.306531], [-157.950736, 21.312509], [-157.951881, 21.318742], [-157.967971, 21.327986], [-157.973334, 21.327426], [-157.989424, 21.317984], [-158.0245, 21.3093], [-158.0883, 21.2988], [-158.1033, 21.2979], [-158.1127, 21.3019], [-158.1211, 21.3169], [-158.1225, 21.3224], [-158.111949, 21.326622], [-158.114196, 21.331123], [-158.119427, 21.334594], [-158.125459, 21.330264], [-158.13324, 21.359207], [-158.1403, 21.3738], [-158.149719, 21.385208], [-158.161743, 21.396282], [-158.1792, 21.4043], [-158.181274, 21.409626], [-158.181, 21.420868], [-158.182648, 21.430073], [-158.192352, 21.44804], [-158.205383, 21.459793], [-158.219446, 21.46978], [-158.233, 21.4876], [-158.231171, 21.523857], [-158.23175, 21.533035], [-158.234314, 21.540058], [-158.250671, 21.557373], [-158.27951, 21.575794], [-158.277679, 21.578789], [-158.254425, 21.582684], [-158.190704, 21.585892], [-158.17, 21.5823], [-158.12561, 21.586739], [-158.10672, 21.596577], [-158.106689, 21.603024], [-158.1095, 21.6057], [-158.108185, 21.607487], [-158.079895, 21.628101], [-158.0668, 21.6437]]], [[[-157.257085, 21.227268], [-157.241534, 21.220969], [-157.226445, 21.220185], [-157.212082, 21.221848], [-157.202125, 21.219298], [-157.192439, 21.207644], [-157.185553, 21.205602], [-157.157103, 21.200706], [-157.148125, 21.200745], [-157.144627, 21.202555], [-157.128207, 21.201488], [-157.113438, 21.197375], [-157.097971, 21.198012], [-157.064264, 21.189076], [-157.053053, 21.188754], [-157.047757, 21.190739], [-157.039987, 21.190909], [-156.999108, 21.182221], [-156.991318, 21.18551], [-156.987768, 21.18935], [-156.982343, 21.207798], [-156.984464, 21.210063], [-156.984032, 21.212198], [-156.974002, 21.218503], [-156.969064, 21.217018], [-156.962847, 21.212131], [-156.951654, 21.191662], [-156.950808, 21.182636], [-156.946159, 21.175963], [-156.903466, 21.16421], [-156.898174, 21.16594], [-156.89613, 21.169561], [-156.896537, 21.172208], [-156.867944, 21.16452], [-156.841592, 21.167926], [-156.821944, 21.174693], [-156.771495, 21.180053], [-156.742231, 21.176214], [-156.738341, 21.17202], [-156.736648, 21.16188], [-156.719386, 21.163911], [-156.712696, 21.161547], [-156.714158, 21.152238], [-156.726033, 21.13236], [-156.748932, 21.1086], [-156.775995, 21.089751], [-156.790815, 21.081686], [-156.794136, 21.075796], [-156.835351, 21.06336], [-156.865795, 21.057801], [-156.877137, 21.0493], [-156.891946, 21.051831], [-156.89517, 21.055771], [-156.953719, 21.067761], [-157.00295, 21.083282], [-157.02617, 21.089015], [-157.032045, 21.091094], [-157.037667, 21.097864], [-157.079696, 21.105835], [-157.095373, 21.10636], [-157.125, 21.1026], [-157.143483, 21.096632], [-157.254061, 21.090601], [-157.298054, 21.096917], [-157.313343, 21.105755], [-157.299187, 21.132488], [-157.299471, 21.135972], [-157.293774, 21.146127], [-157.284346, 21.157755], [-157.276474, 21.163175], [-157.274504, 21.162762], [-157.259911, 21.174875], [-157.254709, 21.181376], [-157.251007, 21.190952], [-157.25026, 21.207739], [-157.256935, 21.215665], [-157.261457, 21.217661], [-157.263163, 21.220873], [-157.26069, 21.225684], [-157.257085, 21.227268]]], [[[-157.010001, 20.929757], [-156.989813, 20.932127], [-156.971604, 20.926254], [-156.937529, 20.925274], [-156.91845, 20.922546], [-156.897169, 20.915395], [-156.837047, 20.863575], [-156.825237, 20.850731], [-156.809576, 20.826036], [-156.808469, 20.820396], [-156.809463, 20.809169], [-156.817427, 20.794606], [-156.838321, 20.764575], [-156.846413, 20.760201], [-156.851481, 20.760069], [-156.869753, 20.754701], [-156.890295, 20.744855], [-156.909081, 20.739533], [-156.949009, 20.738997], [-156.96789, 20.73508], [-156.984747, 20.756677], [-156.994001, 20.786671], [-156.988933, 20.815496], [-156.991834, 20.826603], [-157.006243, 20.849603], [-157.010911, 20.854476], [-157.054552, 20.877219], [-157.059663, 20.884634], [-157.061128, 20.890635], [-157.062511, 20.904385], [-157.05913, 20.913407], [-157.035789, 20.927078], [-157.025626, 20.929528], [-157.010001, 20.929757]]], [[[-156.612012, 21.02477], [-156.612065, 21.027273], [-156.606238, 21.034371], [-156.592256, 21.03288], [-156.580448, 21.020172], [-156.562773, 21.016167], [-156.549813, 21.004939], [-156.546291, 21.005082], [-156.528246, 20.967757], [-156.518707, 20.954662], [-156.512226, 20.95128], [-156.510391, 20.940358], [-156.507913, 20.937886], [-156.49948, 20.934577], [-156.495883, 20.928005], [-156.493263, 20.916011], [-156.481055, 20.898199], [-156.474796, 20.894546], [-156.422668, 20.911631], [-156.386045, 20.919563], [-156.374297, 20.927616], [-156.370729, 20.932669], [-156.352649, 20.941414], [-156.345655, 20.941596], [-156.342365, 20.938737], [-156.332817, 20.94645], [-156.324578, 20.950184], [-156.307198, 20.942739], [-156.286332, 20.947701], [-156.275116, 20.937361], [-156.263107, 20.940888], [-156.242555, 20.937838], [-156.230159, 20.931936], [-156.230089, 20.917864], [-156.226757, 20.916677], [-156.222062, 20.918309], [-156.217953, 20.916573], [-156.216341, 20.907035], [-156.173103, 20.876926], [-156.170458, 20.874605], [-156.166746, 20.865646], [-156.132669, 20.861369], [-156.129381, 20.847513], [-156.115735, 20.827301], [-156.100123, 20.828502], [-156.090291, 20.831872], [-156.059788, 20.81054], [-156.033287, 20.808246], [-156.003532, 20.795545], [-156.002947, 20.789418], [-155.987944, 20.776552], [-155.984587, 20.767496], [-155.986851, 20.758577], [-155.985413, 20.744245], [-155.987216, 20.722717], [-155.991534, 20.713654], [-156.00187, 20.698064], [-156.01415, 20.685681], [-156.020044, 20.686857], [-156.030702, 20.682452], [-156.040341, 20.672719], [-156.043786, 20.664902], [-156.053385, 20.65432], [-156.059753, 20.652044], [-156.081472, 20.654387], [-156.089365, 20.648519], [-156.120985, 20.633685], [-156.129898, 20.627523], [-156.142665, 20.623605], [-156.144588, 20.624032], [-156.148085, 20.629067], [-156.156772, 20.629639], [-156.169732, 20.627358], [-156.173393, 20.6241], [-156.184556, 20.629719], [-156.192938, 20.631769], [-156.210258, 20.628518], [-156.225338, 20.62294], [-156.236145, 20.61595], [-156.265921, 20.601629], [-156.284391, 20.596488], [-156.288037, 20.59203], [-156.293454, 20.588783], [-156.302692, 20.586199], [-156.322944, 20.588273], [-156.351716, 20.58697], [-156.359634, 20.581977], [-156.370725, 20.57876], [-156.377633, 20.578427], [-156.415313, 20.586099], [-156.417523, 20.589728], [-156.415746, 20.594044], [-156.417799, 20.598682], [-156.423141, 20.602079], [-156.427708, 20.598873], [-156.431872, 20.598143], [-156.438385, 20.601337], [-156.444242, 20.607941], [-156.442884, 20.613842], [-156.450651, 20.642212], [-156.445894, 20.64927], [-156.443673, 20.656018], [-156.448656, 20.704739], [-156.451038, 20.725469], [-156.452895, 20.731287], [-156.458438, 20.736676], [-156.462242, 20.753952], [-156.462058, 20.772571], [-156.464043, 20.781667], [-156.473562, 20.790756], [-156.489496, 20.798339], [-156.501688, 20.799933], [-156.506026, 20.799463], [-156.515994, 20.794234], [-156.525215, 20.780821], [-156.537752, 20.778408], [-156.631794, 20.82124], [-156.678634, 20.870541], [-156.688969, 20.888673], [-156.687804, 20.89072], [-156.688132, 20.906325], [-156.691334, 20.91244], [-156.697418, 20.916368], [-156.69989, 20.920629], [-156.69411, 20.952708], [-156.680905, 20.980262], [-156.665514, 21.007054], [-156.652419, 21.008994], [-156.645966, 21.014416], [-156.642592, 21.019936], [-156.644167, 21.022312], [-156.642809, 21.027583], [-156.619581, 21.027793], [-156.612012, 21.02477]]], [[[-156.544169, 20.522802], [-156.550016, 20.520273], [-156.559994, 20.521892], [-156.586238, 20.511711], [-156.603844, 20.524372], [-156.631143, 20.514943], [-156.642347, 20.508285], [-156.647464, 20.512017], [-156.668809, 20.504738], [-156.682939, 20.506775], [-156.703673, 20.527237], [-156.702265, 20.532451], [-156.696662, 20.541646], [-156.6801, 20.557021], [-156.651567, 20.565574], [-156.614598, 20.587109], [-156.610734, 20.59377], [-156.576871, 20.60657], [-156.56714, 20.604895], [-156.553604, 20.594729], [-156.543034, 20.580115], [-156.542808, 20.573674], [-156.548909, 20.56859], [-156.556021, 20.542657], [-156.553018, 20.539382], [-156.540189, 20.534741], [-156.539643, 20.527644], [-156.544169, 20.522802]]], [[[-155.778234, 20.245743], [-155.772734, 20.245409], [-155.746893, 20.232325], [-155.737004, 20.222773], [-155.735822, 20.212417], [-155.732704, 20.205392], [-155.653966, 20.16736], [-155.630382, 20.146916], [-155.624565, 20.145911], [-155.607797, 20.137987], [-155.600909, 20.126573], [-155.598033, 20.124539], [-155.590923, 20.122497], [-155.58168, 20.123617], [-155.568368, 20.130545], [-155.558933, 20.13157], [-155.523661, 20.120028], [-155.516795, 20.11523], [-155.502561, 20.114155], [-155.468211, 20.104296], [-155.443957, 20.095318], [-155.405459, 20.078772], [-155.4024, 20.075541], [-155.387578, 20.067119], [-155.33021, 20.038517], [-155.29548, 20.024438], [-155.282629, 20.021969], [-155.270316, 20.014525], [-155.240933, 19.990173], [-155.204486, 19.969438], [-155.194593, 19.958368], [-155.179939, 19.949372], [-155.149215, 19.922872], [-155.144394, 19.920523], [-155.131235, 19.906801], [-155.124618, 19.897288], [-155.12175, 19.886099], [-155.107541, 19.872467], [-155.098716, 19.867811], [-155.095032, 19.867882], [-155.086341, 19.855399], [-155.084357, 19.849736], [-155.085674, 19.838584], [-155.088979, 19.826656], [-155.094414, 19.81491], [-155.09207, 19.799409], [-155.091216, 19.776368], [-155.093517, 19.771832], [-155.093387, 19.737751], [-155.087118, 19.728013], [-155.079426, 19.726193], [-155.063972, 19.728917], [-155.045382, 19.739824], [-155.006423, 19.739286], [-154.997278, 19.72858], [-154.987168, 19.708524], [-154.981102, 19.690687], [-154.984718, 19.672161], [-154.983778, 19.641647], [-154.974342, 19.633201], [-154.963933, 19.627605], [-154.950359, 19.626461], [-154.947874, 19.62425], [-154.947718, 19.621947], [-154.951014, 19.613614], [-154.947106, 19.604856], [-154.93394, 19.597505], [-154.928205, 19.592702], [-154.924422, 19.586553], [-154.903542, 19.570622], [-154.875, 19.556797], [-154.852618, 19.549172], [-154.837384, 19.538354], [-154.826732, 19.537626], [-154.814417, 19.53009], [-154.809561, 19.522377], [-154.809379, 19.519086], [-154.822968, 19.48129], [-154.838545, 19.463642], [-154.86854, 19.438126], [-154.887817, 19.426425], [-154.928772, 19.397646], [-154.944185, 19.381852], [-154.964619, 19.365646], [-154.980861, 19.349291], [-155.020537, 19.331317], [-155.061729, 19.316636], [-155.113272, 19.290613], [-155.1337, 19.276099], [-155.159635, 19.268375], [-155.172413, 19.26906], [-155.187427, 19.266156], [-155.19626, 19.261295], [-155.205892, 19.260907], [-155.243961, 19.271313], [-155.264619, 19.274213], [-155.296761, 19.266289], [-155.303808, 19.261835], [-155.31337, 19.250698], [-155.341268, 19.234039], [-155.349148, 19.217756], [-155.360631, 19.20893], [-155.378638, 19.202435], [-155.390701, 19.201171], [-155.417369, 19.187858], [-155.427093, 19.179546], [-155.432519, 19.170623], [-155.453516, 19.151952], [-155.465663, 19.146964], [-155.505281, 19.137908], [-155.51474, 19.132501], [-155.51214, 19.128174], [-155.512137, 19.124296], [-155.519652, 19.117025], [-155.526136, 19.115889], [-155.528902, 19.11371], [-155.544806, 19.091059], [-155.551129, 19.08878], [-155.557817, 19.08213], [-155.555326, 19.069377], [-155.555177, 19.053932], [-155.557371, 19.046565], [-155.566446, 19.032531], [-155.576599, 19.027412], [-155.581903, 19.02224], [-155.596032, 18.998833], [-155.596521, 18.980654], [-155.601866, 18.971572], [-155.613966, 18.970399], [-155.625256, 18.961951], [-155.625, 18.959934], [-155.638054, 18.941723], [-155.658486, 18.924835], [-155.672005, 18.917466], [-155.681825, 18.918694], [-155.687716, 18.923358], [-155.690171, 18.932195], [-155.693117, 18.940542], [-155.726043, 18.969437], [-155.763598, 18.981837], [-155.806109, 19.013967], [-155.853943, 19.023762], [-155.88155, 19.036644], [-155.884077, 19.039266], [-155.886278, 19.05576], [-155.903693, 19.080777], [-155.908355, 19.081138], [-155.921389, 19.121183], [-155.917292, 19.155963], [-155.903339, 19.217792], [-155.90491, 19.230147], [-155.902565, 19.258427], [-155.895435, 19.274639], [-155.890842, 19.298905], [-155.887356, 19.337101], [-155.888701, 19.348031], [-155.898792, 19.377984], [-155.913849, 19.401107], [-155.909087, 19.415455], [-155.921707, 19.43055], [-155.924269, 19.438794], [-155.925166, 19.468081], [-155.922609, 19.478611], [-155.924124, 19.481406], [-155.930523, 19.484921], [-155.935641, 19.485628], [-155.936403, 19.481905], [-155.939145, 19.481577], [-155.95149, 19.486649], [-155.952897, 19.488805], [-155.953663, 19.510003], [-155.960457, 19.546612], [-155.962264, 19.551779], [-155.965211, 19.554745], [-155.96935, 19.555963], [-155.970969, 19.586328], [-155.978206, 19.608159], [-155.997728, 19.642816], [-156.028982, 19.650098], [-156.032928, 19.653905], [-156.034994, 19.65936], [-156.033326, 19.66923], [-156.027427, 19.672154], [-156.029281, 19.678908], [-156.036079, 19.690252], [-156.04796, 19.698938], [-156.051652, 19.703649], [-156.052485, 19.718667], [-156.064364, 19.730766], [-156.05722, 19.742536], [-156.052315, 19.756836], [-156.049651, 19.780452], [-156.021732, 19.8022], [-156.006267, 19.81758], [-155.982821, 19.845651], [-155.976651, 19.85053], [-155.964817, 19.855183], [-155.949251, 19.857034], [-155.945297, 19.853443], [-155.940311, 19.852305], [-155.925843, 19.858928], [-155.926938, 19.870221], [-155.92549, 19.875], [-155.915662, 19.887126], [-155.901987, 19.912081], [-155.894099, 19.923135], [-155.894474, 19.926927], [-155.892533, 19.932162], [-155.866919, 19.954172], [-155.856588, 19.968885], [-155.840708, 19.976952], [-155.838692, 19.975527], [-155.835312, 19.976078], [-155.831948, 19.982775], [-155.828965, 19.995542], [-155.825473, 20.025944], [-155.828182, 20.035424], [-155.850385, 20.062506], [-155.866931, 20.078652], [-155.88419, 20.10675], [-155.899149, 20.145728], [-155.906035, 20.205157], [-155.901452, 20.235787], [-155.890663, 20.25524], [-155.882631, 20.263026], [-155.873921, 20.267744], [-155.853293, 20.271548], [-155.811459, 20.26032], [-155.783242, 20.246395], [-155.778234, 20.245743]]], [[[-178.304504, 28.385405], [-178.314468, 28.385746], [-178.330566, 28.387459], [-178.342102, 28.388927], [-178.339813, 28.392273], [-178.333344, 28.392746], [-178.320648, 28.392807], [-178.307816, 28.394899], [-178.298874, 28.400175], [-178.291077, 28.407391], [-178.290497, 28.394138], [-178.29454, 28.388641], [-178.304504, 28.385405]]], [[[-175.737091, 27.928402], [-175.733627, 27.927259], [-175.73494, 27.924505], [-175.73735, 27.92152], [-175.740997, 27.919806], [-175.741638, 27.923454], [-175.737091, 27.928402]]], [[[-175.741394, 27.914927], [-175.738281, 27.913597], [-175.740921, 27.910934], [-175.740662, 27.907433], [-175.743881, 27.907583], [-175.744064, 27.912766], [-175.741394, 27.914927]]], [[[-175.861572, 27.782007], [-175.862808, 27.786123], [-175.858521, 27.786539], [-175.858475, 27.78336], [-175.861572, 27.782007]]], [[[-175.811966, 27.777546], [-175.814713, 27.779062], [-175.818054, 27.779791], [-175.816559, 27.782473], [-175.812057, 27.78273], [-175.807434, 27.781155], [-175.807541, 27.778721], [-175.811966, 27.777546]]], [[[-175.905075, 27.766842], [-175.895187, 27.765072], [-175.895706, 27.762028], [-175.904953, 27.762661], [-175.906647, 27.765076], [-175.905075, 27.766842]]], [[[-175.943802, 27.758139], [-175.934143, 27.759706], [-175.932022, 27.756479], [-175.929947, 27.748564], [-175.935898, 27.747883], [-175.942276, 27.752869], [-175.943802, 27.758139]]], [[[-173.982803, 26.085909], [-173.969421, 26.088566], [-173.95903, 26.080111], [-173.956879, 26.061834], [-173.965347, 26.055977], [-173.977859, 26.062843], [-173.982803, 26.085909]]]]}, "type": "Feature", "properties": {"CENSUSAREA": 6422.628, "STATE": "15", "LSAD": "", "NAME": "Hawaii", "GEO_ID": "0400000US15"}}

console.log(testHI);

const svgo = new SVGO();
mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4M29iazA2Z2gycXA4N2pmbDZmangifQ.-g_vE53SD2WrJ6tFX7QHmA';

const SCALE = 1;
const NUM_POINTS = 2000;

let App = class App extends React.PureComponent {
  mouseCoordinates = {
    x: 0,
    y: 0
  };
  mapContainer = null;

  constructor(props: Props) {
    super(props);
    this.state = {
      helpText: 'Drag and drop an SVG on the map.'
    };
  }

  componentDidMount() {
    this.map = new mapboxgl.Map({
      container: this.mapContainer,
      style: 'mapbox://styles/mapbox/light-v9',
      center: [5, 34],
      zoom: 1.5
    });

    this.draw = new MapboxDraw();

    this.map.on('load', () => {
      this.map.addControl(this.draw);
    });
  }

  download = () => {
    const blob = new Blob([
      JSON.stringify(this.draw.getAll(), null, 2)
    ], {
      type: 'text/plain;charset=utf-8'
    });

    saveAs(blob, 'features.geojson');
  };

  trackCoordinates = e => {
    this.mouseCoordinates = {
      x: e.screenX,
      y: e.screenY
    }
  };

  setMapContainer = el => {
    this.mapContainer = el;
  };

  buildFeature = data => {
    const {id, coords} = data;
    let feature = {
      type: 'Feature',
      properties: {},
      geometry: {}
    }

    if (id) {
      feature.properties.id = id;
    }

    // If the first and last coords match it should be drawn as a polygon
    if (coords[0][0] === coords[coords.length - 1][0] &&
        coords[0][1] === coords[coords.length - 1][1]) {
          feature.geometry = {
            type: 'Polygon',
            coordinates: [
              coords.map(d => {
                const c = this.map.unproject(d);
                return [c.lng, c.lat];
              })
            ]
          };
    } else {
      const getSum = (total, num) => {
          return total + num;
      }
      try {
        // try to see if it should be a multipolygon
        let distances = [];
        let splits = [];
        coords.forEach((c, idx) => {
          if(idx > 0){
            let from = turf.point([this.map.unproject(coords[idx - 1])['lng'], this.map.unproject(coords[idx - 1])['lat']]);
            let to = turf.point([this.map.unproject(c)['lng'], this.map.unproject(c)['lat']]);
            let options = {units: 'miles'};

            let distance = turf.distance(from, to, options);
            // get distances between points
            distances.push(distance);
          }
        });

        let distAvg = distances.reduce(getSum)/distances.length;
        coords.forEach((c, idx) => {
          if(idx > 0){
            let from = turf.point([this.map.unproject(coords[idx - 1])['lng'], this.map.unproject(coords[idx - 1])['lat']]);
            let to = turf.point([this.map.unproject(c)['lng'], this.map.unproject(c)['lat']]);
            let options = {units: 'miles'};
            let distance = turf.distance(from, to, options);
            // if the following coordinate is ~2.5 farther away than average, it is most likely a new polygon
            if(distance > distAvg*2.5){
              splits.push(idx);
            }
          }
        });

        // idx only gets to last split - needs to get to the end of the shape
        splits.push(NUM_POINTS);

        let newShapeArray = [];
        splits.forEach((s, idx) => {
          let shape = [];
          if(idx === 0){
            for(var i = 0; i < s; i++){
              shape.push([this.map.unproject(coords[i])['lng'], this.map.unproject(coords[i])['lat']]);
            }
          } else {
            for(var i = splits[idx-1]; i < s; i++){
              shape.push([this.map.unproject(coords[i])['lng'], this.map.unproject(coords[i])['lat']]);
            }
          }
          newShapeArray.push([shape]);
        });

        newShapeArray.forEach(shape => {
          shape[0].push(shape[0][0]);
        });

        feature.geometry = {
          type: 'MultiPolygon',
          coordinates: newShapeArray
        };
      }
      catch(err) {
        feature.geometry = {
          type: 'LineString',
          coordinates: coords.map(d => {
            const c = this.map.unproject(d);
            return [c.lng, c.lat];
          })
        };
      }


    }

    return feature;
  };

  calculateCoords = svg => {
    const { x, y } = this.mouseCoordinates;

    // Attempt a couple methods to get width/height values on the SVG element
    // to return reasonable x/y coordinates on the map.
    let { width, height } = svg.getBBox();

    if (width === 0 && svg.getAttribute('width')) {
      width = parseInt(svg.getAttribute('width'), 10);
    }

    if (height === 0 && svg.getAttribute('height')) {
      height = parseInt(svg.getAttribute('height'), 10);
    }

    return {
      x: x - (width / 2),
      y: y - (height / 2)
    }
  };

  svgToGeoJSON = svgString => {

    // Create an empty container to fetch paths using the dom
    const empty = document.createElement('div');
    empty.innerHTML = svgString;

    const coordinates = this.calculateCoords(empty.querySelector('svg'));
    const paths = empty.querySelectorAll('path');

    if (!paths.length) {
      this.setState({
        helpText: 'No paths were found in this SVG'
      });
      return;
    }

    Array
      .from(paths)
      .map(path => pathToCoords(
        path,
        SCALE,
        NUM_POINTS,
        coordinates.x,
        coordinates.y
      ))
      .map(this.buildFeature)
      .forEach(this.draw.add);

    this.setState({
      helpText: 'Drag and drop an SVG on the map.'
    });
  };

  onUpload = files => {
    const file = files[0];
    const { type } = file;

    this.setState({
      helpText: (
        <span className="loading loading--s loading--dark" />
      )
    });

    if (type !== 'image/svg+xml') {
      this.setState({
        helpText: 'File type must be SVG'
      });
      return;
    }

    const reader = new FileReader();
    reader.addEventListener('load', d => {

      svgo.postMessage({
        svg: d.target.result
      });

      svgo.addEventListener('message', e => {
        pathologize(e.data)
          .then(this.svgToGeoJSON)
          .catch(err => {
            console.error(err);
            this.setState({
              helpText: 'Error parsing SVG'
            });
            return;
          });
      });
    });

    reader.readAsText(file);
  };

  render() {
    const { helpText } = this.state;
    const { connectDropTarget, isOver } = this.props;

    return connectDropTarget(
      <div onMouseMove={this.trackCoordinates}>
        <div className="flex-parent flex-parent--end-cross flex-parent--center-main absolute top right bottom left">
          <div className="flex-child mb24 z1 txt-s txt-bold flex-parent">
            <div className="flex-child bg-darken75 color-white inline-block pl24 pr12 py12 round-l-full">
              {helpText}
            </div>
            <button className="flex-child btn btn--purple px24 round-r-full" onClick={this.download}>
              Download
            </button>
          </div>
        </div>

        {isOver && <div className="bg-darken25 fixed left right top bottom events-none z5" />}
        <div ref={this.setMapContainer} className="absolute top right left bottom" />
      </div>
    );
  }
}

const dropTarget = {
  drop: (props, monitor, component) =>
    component.onUpload(monitor.getItem().files)
};

const withDragDrop = DropTarget(
  NativeTypes.FILE,
  dropTarget,
  (connect, monitor) => ({
    connectDropTarget: connect.dropTarget(),
    isOver: monitor.isOver()
  })
);

export default DragDropContext(HTML5Backend)(withDragDrop(App));
